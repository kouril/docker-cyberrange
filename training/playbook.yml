---

- hosts: all
  become: yes

  vars_files:
    - "vars/root_ssh_keys.yml"
    - "vars/training_network.yml"

  tasks:
    - name: Prepare Ansible playbook for the second stage
      git:
        repo: root@192.168.4.26:/root/deployment.git
        dest: /root/deployment

    - name: Install Ansible
      apt:
        name: ansible
        update_cache: yes

    - name: Adapt SSH client configuration
      copy:
        src: ssh_config.conf
        dest: /etc/ssh/ssh_config.d/training.conf
        owner: root

  roles:
    - role: common

    - role: users
      vars:
        users: 
          - name: "training"
            passwd: "strudl"
            ssh_priv_key_path: "ssh/user"
          - name: "root"
            ssh_priv_key_path: "ssh/master"

    - role: lxd
    - role: lxd-container
      vars:
        containers:
          - name: stage1
            ipv4_address: 10.0.10.10
            image: images:debian/buster/cloud
            type: lxd
          - name: stage2
            ipv4_address: 10.0.10.11
            image: images:debian/buster/cloud
            type: lxd
