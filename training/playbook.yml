---

- hosts: all
  become: yes

  vars_files:
    - "vars/root_ssh_keys.yml"
    - "vars/training_network.yml"
    - "vars/training_nodes.yml"

  tasks:
    - name: Prepare Ansible playbook for the second stage
      git:
        repo: root@192.168.4.26:/root/deployment.git
        dest: /root/deployment

    - name: Install Ansible
      apt:
        name: ansible
        update_cache: yes

    - name: Adapt SSH client configuration
      copy:
        src: ssh_config.conf
        dest: /etc/ssh/ssh_config.d/training.conf
        owner: root

    - name: Create /etc/hosts records
      lineinfile:
        path: /etc/hosts
        line: "{{ item.ipv4_address }} {{ item.name }}"
      loop: "{{ containers }}"

    - name: Create list of nodes to install in the second stage
      template:
        src: inventory.j2
        dest: /root/inner-hosts


  roles:
    - role: common

    - role: users
      vars:
        users: 
          - name: "training"
            passwd: "strudl"
            ssh_priv_key_path: "ssh/user"
          - name: "root"
            ssh_priv_key_path: "ssh/master"

    - role: lxd
    - role: lxd-container
